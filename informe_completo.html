<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Recursos -- Logicalis</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;600;700&display=swap');
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --accent: #00d4aa;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --border: #2d3748;
            --vacation: #f59e0b;
            --project: #3b82f6;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1800px; margin: 0 auto; padding: 1rem 2rem; }
        header { text-align: center; margin-bottom: 1rem; padding: 1rem 1.5rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); }
        h1 { font-size: 1.8rem; background: linear-gradient(135deg, var(--accent), #3b82f6); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--accent); }
        h3 { font-size: 1rem; margin-bottom: 0.75rem; color: var(--text-primary); }
        
        .main-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; }
        .main-tab { flex: 1; padding: 1rem 1.5rem; background: var(--bg-card); border: 2px solid var(--border); cursor: pointer; font-weight: 600; font-size: 1rem; text-align: center; transition: all 0.2s; color: var(--text-secondary); }
        .main-tab:first-child { border-radius: 12px 0 0 12px; }
        .main-tab:last-child { border-radius: 0 12px 12px 0; border-left: none; }
        .main-tab:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .main-tab.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        .main-tab-icon { width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        .header-icon { width: 32px; height: 32px; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        .tab-icon { width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 0.4rem; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; }
        .loading-spinner { font-size: 3rem; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-text { margin-top: 1rem; font-size: 1.2rem; color: var(--text-secondary); }
        .error-box { background: var(--danger)22; border: 1px solid var(--danger); padding: 1.5rem; border-radius: 12px; text-align: center; color: var(--danger); }
        
        .main-content { display: none; }
        .main-content.visible { display: block; }
        
        .filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); align-items: flex-start; }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-group label { font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; }
        select, input, button { padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem; }
        input[type="date"] { cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        button { cursor: pointer; background: var(--accent); color: var(--bg-primary); font-weight: 600; border: none; }
        button:hover { opacity: 0.9; }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        
        .person-selector { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; min-width: 220px; }
        .person-item { display: flex; align-items: center; padding: 0.5rem 0.75rem; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border); }
        .person-item:last-child { border-bottom: none; }
        .person-item:hover { background: var(--bg-card); }
        .person-item input[type="checkbox"] { margin-right: 0.5rem; accent-color: var(--accent); width: 16px; height: 16px; }
        .person-item.selected { background: var(--accent)22; }
        .person-item .person-name { flex: 1; font-size: 0.85rem; }
        .select-all-btn { padding: 0.4rem 0.75rem; font-size: 0.8rem; margin: 0.5rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-card); padding: 1rem; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent); }
        .stat-value.vacation { color: var(--vacation); }
        .stat-value.project { color: var(--project); }
        .stat-value.danger { color: var(--danger); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        
        .section { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 1rem; overflow: hidden; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); background: var(--bg-secondary); flex-wrap: wrap; gap: 1rem; }
        .section-header h2 { margin: 0; }
        .section-content { padding: 0; }
        
        .tabs { display: flex; gap: 0.25rem; }
        .tab { padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-secondary); font-weight: 600; font-size: 0.8rem; transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); color: var(--text-primary); }
        .tab.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.6rem; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        th { background: var(--bg-secondary); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.7rem; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .badge-vacation { background: var(--vacation); color: #000; }
        .badge-project { background: var(--project); color: #fff; }
        .table-wrapper { max-height: 350px; overflow-y: auto; }
        
        .timeline-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .view-toggle { display: flex; gap: 0; }
        .view-toggle button { padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 0; border: 2px solid var(--border); background: var(--bg-secondary); color: var(--text-secondary); font-weight: 600; transition: all 0.2s; }
        .view-toggle button:first-child { border-radius: 6px 0 0 6px; }
        .view-toggle button:last-child { border-radius: 0 6px 6px 0; }
        .view-toggle button:not(:last-child) { border-right: none; }
        .view-toggle button:hover { background: var(--bg-card); color: var(--text-primary); }
        .view-toggle button.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        
        .timeline-scroll { overflow-x: auto; }
        .timeline-header { display: flex; position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; border-bottom: 1px solid var(--border); }
        .timeline-header-name { min-width: 150px; max-width: 150px; padding: 0.5rem; font-weight: 600; font-size: 0.75rem; color: var(--text-secondary); border-right: 1px solid var(--border); position: sticky; left: 0; background: var(--bg-secondary); z-index: 11; }
        .timeline-header-dates { display: flex; flex: 1; }
        .timeline-date { flex: 1; min-width: 32px; padding: 0.35rem 0.15rem; text-align: center; font-size: 0.6rem; color: var(--text-secondary); border-right: 1px solid var(--border); }
        .timeline-date.today { background: var(--accent); color: var(--bg-primary); font-weight: 600; }
        .timeline-date.month-start { border-left: 2px solid var(--accent); }
        .timeline-month-label { background: var(--accent); color: var(--bg-primary); font-weight: 700; font-size: 0.7rem; padding: 0.2rem 0.4rem; }
        
        .timeline-row { display: flex; border-bottom: 1px solid var(--border); min-height: 40px; }
        .timeline-row:hover { background: rgba(255,255,255,0.02); }
        .timeline-row-name { min-width: 150px; max-width: 150px; padding: 0.35rem 0.5rem; font-size: 0.75rem; display: flex; align-items: center; border-right: 1px solid var(--border); position: sticky; left: 0; background: var(--bg-card); z-index: 5; }
        .timeline-row-name.overloaded { background: var(--danger)33; }
        .timeline-row-cells { display: flex; flex: 1; position: relative; }
        .timeline-cell { flex: 1; min-width: 32px; border-right: 1px solid var(--border); }
        .timeline-cell.month-start { border-left: 2px solid var(--accent)55; }
        .timeline-bar { position: absolute; height: 14px; border-radius: 3px; font-size: 0.5rem; display: flex; align-items: center; padding: 0 3px; overflow: hidden; white-space: nowrap; cursor: pointer; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .timeline-bar.vacation { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; }
        .timeline-bar.project { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; }
        .timeline-bar:hover { filter: brightness(1.1); z-index: 10; height: 18px; }
        
        .legend { display: flex; gap: 1rem; margin-left: auto; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .legend-color.vacation { background: var(--vacation); }
        .legend-color.project { background: var(--project); }
        
        .report-tabs { display: flex; gap: 0; margin-bottom: 0; }
        .report-tab { flex: 1; padding: 1rem 1.5rem; background: var(--bg-card); border: 1px solid var(--border); border-bottom: none; cursor: pointer; font-weight: 600; font-size: 1rem; text-align: center; transition: all 0.2s; color: var(--text-secondary); border-radius: 12px 12px 0 0; }
        .report-tab:not(:first-child) { margin-left: -1px; }
        .report-tab:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .report-tab.active { background: var(--bg-secondary); color: var(--accent); border-color: var(--accent); border-bottom: 2px solid var(--bg-secondary); z-index: 1; position: relative; }
        .report-panel { display: none; }
        .report-panel.active { display: block; }
        .report-panel .section { border-radius: 0 0 12px 12px; border-top: 2px solid var(--accent); }
        
        .occupancy-timeline { display: flex; align-items: center; gap: 2px; flex-wrap: wrap; }
        .occupancy-day { width: 28px; height: 28px; border-radius: 4px; font-size: 0.55rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
        .occupancy-day:hover { transform: scale(1.2); z-index: 10; }
        .occupancy-day .day-num { font-size: 0.5rem; opacity: 0.7; }
        .occupancy-day .day-hours { font-size: 0.6rem; }
        .occupancy-day.ok { background: var(--success); color: #fff; }
        .occupancy-day.warning { background: var(--warning); color: #000; }
        .occupancy-day.danger { background: var(--danger); color: #fff; }
        .occupancy-day.empty { background: var(--bg-secondary); color: var(--text-secondary); }
        
        .tooltip { position: fixed; background: var(--bg-secondary); border: 1px solid var(--border); padding: 0.75rem; border-radius: 8px; font-size: 0.8rem; z-index: 1000; pointer-events: none; display: none; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .tooltip.show { display: block; }
        .tooltip-task { padding: 0.25rem 0; border-bottom: 1px solid var(--border); }
        .tooltip-task:last-child { border-bottom: none; }
        .hidden { display: none; }
        .no-data { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .new-file-btn { margin-left: auto; }
        
        .editor-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
        @media (max-width: 1200px) { .editor-grid { grid-template-columns: 1fr; } }
        
        .master-section { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 1rem; }
        .master-list { background: var(--bg-secondary); border-radius: 6px; max-height: 180px; overflow-y: auto; margin-bottom: 0.75rem; }
        .master-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .master-item:last-child { border-bottom: none; }
        .master-item:hover { background: var(--bg-card); }
        .add-master-row { display: flex; gap: 0.5rem; }
        .add-master-row input { flex: 1; }
        
        /* Select con b√∫squeda integrada */
        .searchable-select { position: relative; width: 100%; }
        .searchable-select-input { width: 100%; padding: 0.5rem 2.5rem 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem; cursor: pointer; }
        .searchable-select-input:focus { outline: none; border-color: var(--accent); }
        .searchable-select-arrow { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary); transition: transform 0.2s; }
        .searchable-select.open .searchable-select-arrow { transform: translateY(-50%) rotate(180deg); }
        .searchable-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; margin-top: 0.25rem; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .searchable-select.open .searchable-select-dropdown { display: block; }
        .searchable-select-search { padding: 0.5rem; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
        .searchable-select-search input { width: 100%; padding: 0.4rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.85rem; }
        .searchable-select-options { max-height: 200px; overflow-y: auto; }
        .searchable-select-option { padding: 0.6rem 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .searchable-select-option:last-child { border-bottom: none; }
        .searchable-select-option:hover { background: var(--bg-card); }
        .searchable-select-option.selected { background: var(--accent)22; color: var(--accent); }
        .searchable-select-option.hidden { display: none; }
        .searchable-select-no-results { padding: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.85rem; }
        
        .entry-form { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .form-group label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; }
        .form-group select, .form-group input { width: 100%; }
        .form-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        
        .entries-table-wrapper { max-height: 400px; overflow-y: auto; }
        .entries-table { width: 100%; }
        .entries-table th, .entries-table td { padding: 0.5rem; font-size: 0.8rem; }
        .entries-table th input, .entries-table th select { width: 100%; padding: 0.3rem; font-size: 0.75rem; margin-top: 0.3rem; }
        .action-btns { display: flex; gap: 0.3rem; }
        
        .download-section { display: flex; gap: 1rem; align-items: center; padding: 1rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 1.5rem; flex-wrap: wrap; }
        .download-section span { color: var(--text-secondary); font-size: 0.9rem; }
        .file-info { background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; }
        
        /* ========== RESPONSIVE STYLES ========== */
        /* Tablets y pantallas medianas */
        @media (max-width: 1024px) {
            .container { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            .main-tab { padding: 0.75rem 1rem; font-size: 0.9rem; }
            .main-tab-icon { width: 18px; height: 18px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .stat-value { font-size: 1.5rem; }
            .timeline-controls { flex-direction: column; align-items: stretch; }
            .timeline-controls > * { width: 100%; }
            .view-toggle { width: 100%; }
            .view-toggle button { flex: 1; }
            .legend { margin-left: 0; margin-top: 0.5rem; }
            .section-header { flex-direction: column; align-items: flex-start; }
            .tabs { flex-wrap: wrap; width: 100%; }
            .tab { flex: 1; min-width: calc(50% - 0.5rem); }
            .report-tabs { flex-direction: column; }
            .report-tab { border-radius: 12px 12px 0 0; margin-left: 0; margin-bottom: 0.25rem; }
            .report-tab:not(:first-child) { margin-left: 0; }
        }
        
        /* M√≥viles grandes */
        @media (max-width: 768px) {
            .container { padding: 0.75rem; }
            header { padding: 0.75rem 1rem; }
            h1 { font-size: 1.3rem; }
            .header-icon { width: 24px; height: 24px; margin-right: 0.4rem; }
            .main-tabs { flex-direction: column; gap: 0.5rem; }
            .main-tab { border-radius: 12px !important; border: 2px solid var(--border) !important; }
            .main-tab:first-child, .main-tab:last-child { border-radius: 12px; }
            .main-tab:not(:first-child) { border-left: 2px solid var(--border); }
            .filters { flex-direction: column; padding: 0.75rem; }
            .filter-group { width: 100%; }
            .person-selector { min-width: 100%; max-height: 150px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .stat-card { padding: 0.75rem; }
            .stat-value { font-size: 1.3rem; }
            .stat-label { font-size: 0.7rem; }
            .section-header { padding: 0.75rem; }
            .section-header h2 { font-size: 1rem; }
            .tabs { flex-direction: column; gap: 0.5rem; }
            .tab { width: 100%; min-width: 100%; }
            .timeline-header-name { min-width: 120px; max-width: 120px; font-size: 0.7rem; }
            .timeline-row-name { min-width: 120px; max-width: 120px; font-size: 0.7rem; }
            .timeline-date { min-width: 28px; font-size: 0.55rem; padding: 0.25rem 0.1rem; }
            .timeline-cell { min-width: 28px; }
            .timeline-bar { font-size: 0.45rem; height: 12px; }
            .table-wrapper { max-height: 300px; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.4rem 0.3rem; font-size: 0.75rem; }
            .editor-grid { grid-template-columns: 1fr; gap: 1rem; }
            .entry-form { padding: 1rem; }
            .form-grid { grid-template-columns: 1fr; }
            .form-actions { flex-direction: column; }
            .form-actions button { width: 100%; }
            .download-section { flex-direction: column; align-items: stretch; }
            .download-section button { width: 100%; }
            .master-section { padding: 0.75rem; }
            .master-list { max-height: 150px; }
            .add-master-row { flex-direction: column; }
            .add-master-row button { width: 100%; }
            .entries-table-wrapper { max-height: 300px; }
            .entries-table th, .entries-table td { padding: 0.4rem 0.3rem; font-size: 0.7rem; }
            .action-btns { flex-direction: column; }
            .action-btns button { width: 100%; }
            .view-toggle { flex-direction: column; }
            .view-toggle button { border-radius: 6px !important; border: 2px solid var(--border) !important; }
            .view-toggle button:not(:first-child) { border-top: none; }
            .view-toggle button:first-child { border-radius: 6px 6px 0 0; }
            .view-toggle button:last-child { border-radius: 0 0 6px 6px; }
        }
        
        /* M√≥viles peque√±os */
        @media (max-width: 480px) {
            .container { padding: 0.5rem; }
            header { padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; }
            h1 { font-size: 1.1rem; }
            .header-icon { width: 20px; height: 20px; }
            .main-tab { padding: 0.6rem 0.75rem; font-size: 0.85rem; }
            .main-tab-icon { width: 16px; height: 16px; margin-right: 0.3rem; }
            .filters { padding: 0.5rem; gap: 0.75rem; }
            .filter-group label { font-size: 0.8rem; }
            select, input, button { padding: 0.4rem 0.75rem; font-size: 0.85rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .stat-value { font-size: 1.2rem; }
            .section-header { padding: 0.5rem; }
            h2 { font-size: 0.95rem; }
            h3 { font-size: 0.9rem; }
            .tab { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
            .tab-icon { width: 14px; height: 14px; }
            .timeline-header-name { min-width: 100px; max-width: 100px; padding: 0.4rem 0.3rem; font-size: 0.65rem; }
            .timeline-row-name { min-width: 100px; max-width: 100px; padding: 0.3rem 0.4rem; font-size: 0.65rem; }
            .timeline-date { min-width: 24px; font-size: 0.5rem; padding: 0.2rem 0.05rem; }
            .timeline-cell { min-width: 24px; }
            .timeline-bar { font-size: 0.4rem; height: 10px; padding: 0 2px; }
            .timeline-controls button { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
            #currentPeriod { font-size: 0.85rem; min-width: auto; }
            table { font-size: 0.7rem; }
            th, td { padding: 0.3rem 0.2rem; font-size: 0.7rem; }
            .badge { padding: 0.15rem 0.4rem; font-size: 0.65rem; }
            .entry-form { padding: 0.75rem; }
            .form-group label { font-size: 0.75rem; }
            .master-section { padding: 0.5rem; }
            .master-item { padding: 0.4rem 0.5rem; font-size: 0.8rem; }
            .download-section { padding: 0.75rem; }
            .file-info { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
            .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .select-all-btn { padding: 0.3rem 0.6rem; font-size: 0.75rem; margin: 0.3rem; }
        }
        
        /* Orientaci√≥n horizontal en m√≥viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .filters { flex-direction: row; flex-wrap: wrap; }
            .filter-group { flex: 1; min-width: calc(50% - 0.5rem); }
        }
        
        /* Mejoras de accesibilidad t√°ctil */
        @media (hover: none) and (pointer: coarse) {
            button, .tab, .main-tab, .report-tab, .person-item { min-height: 44px; }
            .timeline-bar { min-height: 20px; }
            input, select { min-height: 44px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h1>
                <img src="favicon.svg" alt="Icono" class="header-icon">
                Gesti√≥n de Recursos - Logicalis
            </h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="userInfo" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                <button id="btnGestionUsuarios" class="btn-secondary" onclick="window.location.href='gestion_usuarios.html'" style="display: none;">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Usuarios
                </button>
                <button class="btn-secondary" onclick="logout()">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <div class="main-tabs">
        <div class="main-tab active" data-maintab="reports">
            <svg class="main-tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM7 7h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z"/>
            </svg>
            Informes
        </div>
        <div class="main-tab" data-maintab="editor">
            <svg class="main-tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            Editor de Datos
        </div>
    </div>

    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner">‚è≥</div>
        <div class="loading-text">Cargando datos...</div>
    </div>

    <!-- REPORTS TAB -->
    <div class="tab-content active" id="reportsTab">
        <div class="main-content" id="mainContent">
            
            <!-- GLOBAL FILTERS BAR -->
            <div class="section" style="margin-bottom:0.75rem;">
                <div class="filters" style="border-radius:12px;">
                    <div class="filter-group">
                        <label>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;">
                                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                            </svg>
                            Personas
                        </label>
                        <div>
                            <button class="select-all-btn btn-secondary" id="selectAllBtn">Todas</button>
                            <button class="select-all-btn btn-secondary" id="selectNoneBtn">Ninguna</button>
                        </div>
                        <input type="text" id="searchPersonSelector" class="search-master-input" placeholder="üîç Buscar persona..." style="width:100%;margin-bottom:0.5rem;padding:0.4rem;font-size:0.85rem;">
                        <div class="person-selector" id="personSelector"></div>
                    </div>
                    <div class="filter-group">
                        <label>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;">
                                <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                            </svg>
                            Proyecto
                        </label>
                        <div class="searchable-select" id="filterProjectSelect" style="min-width:200px;">
                            <input type="text" class="searchable-select-input" id="filterProjectInput" placeholder="Todos" readonly>
                            <span class="searchable-select-arrow">‚ñº</span>
                            <div class="searchable-select-dropdown">
                                <div class="searchable-select-search">
                                    <input type="text" placeholder="üîç Buscar proyecto..." id="filterProjectSearch">
                                </div>
                                <div class="searchable-select-options" id="filterProjectOptions"></div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                            </svg>
                            Tarea
                        </label>
                        <div class="searchable-select" id="filterTaskSelect" style="min-width:200px;">
                            <input type="text" class="searchable-select-input" id="filterTaskInput" placeholder="Todas" readonly>
                            <span class="searchable-select-arrow">‚ñº</span>
                            <div class="searchable-select-dropdown">
                                <div class="searchable-select-search">
                                    <input type="text" placeholder="üîç Buscar tarea..." id="filterTaskSearch">
                                </div>
                                <div class="searchable-select-options" id="filterTaskOptions"></div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;">
                                <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7.01v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
                            </svg>
                            Tipo
                        </label>
                        <select id="filterType">
                            <option value="">Todo</option>
                            <option value="vacation">Solo Vacaciones</option>
                            <option value="project">Solo Proyectos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;">
                                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                            </svg>
                            Fecha Desde
                        </label>
                        <input type="date" id="filterDateFrom">
                    </div>
                    <div class="filter-group">
                        <label>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;">
                                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                            </svg>
                            Fecha Hasta
                        </label>
                        <input type="date" id="filterDateTo">
                    </div>
                    <div class="filter-group" style="justify-content:flex-end;margin-top:auto;">
                        <button id="clearFilters" class="btn-secondary">
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;vertical-align:middle;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            Limpiar
                        </button>
                        <button id="refreshDataBtn" class="btn-success">
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;vertical-align:middle;">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                            Refrescar
                        </button>
                    </div>
                </div>
            </div>

            <!-- STATS BAR -->
            <div class="stats-grid" style="margin-bottom:0.75rem;">
                <div class="stat-card"><div class="stat-value" id="statPersons">0</div><div class="stat-label">Personas</div></div>
                <div class="stat-card"><div class="stat-value project" id="statProjects">0</div><div class="stat-label">Proyectos</div></div>
                <div class="stat-card"><div class="stat-value vacation" id="statVacations">0</div><div class="stat-label">Vacaciones</div></div>
                <div class="stat-card"><div class="stat-value" id="statAssignments">0</div><div class="stat-label">Asignaciones</div></div>
                <div class="stat-card"><div class="stat-value danger" id="statOverloaded">0</div><div class="stat-label">D√≠as Sobrecarga</div></div>
            </div>

            <!-- REPORT TABS -->
            <div class="report-tabs">
                <div class="report-tab active" data-report="timeline">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                    </svg>
                    Timeline
                </div>
                <div class="report-tab" data-report="tables">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
                    </svg>
                    Tablas
                </div>
            </div>

            <!-- TIMELINE PANEL -->
            <div class="report-panel active" id="timelinePanel">
                <div class="section">
                    <div class="section-header">
                        <div class="timeline-controls">
                            <div class="view-toggle" id="viewToggle">
                                <button data-view="week">Semana</button>
                                <button data-view="month" class="active">Mes</button>
                                <button data-view="quarter">Trimestre</button>
                                <button data-view="year">A√±o</button>
                            </div>
                            <button class="btn-secondary" id="prevBtn">‚óÄ</button>
                            <span id="currentPeriod" style="min-width:180px;text-align:center;font-weight:600;font-size:1rem;"></span>
                            <button class="btn-secondary" id="nextBtn">‚ñ∂</button>
                            <button id="todayBtn">Hoy</button>
                        </div>
                        <div class="legend">
                            <div class="legend-item"><div class="legend-color vacation"></div>Vacaciones</div>
                            <div class="legend-item"><div class="legend-color project"></div>Proyectos</div>
                        </div>
                    </div>
                    <div class="section-content timeline-scroll" id="timelineContainer" style="max-height:450px;overflow:auto;"></div>
                </div>
            </div>

            <!-- TABLES PANEL -->
            <div class="report-panel" id="tablesPanel">
                <div class="section">
                    <div class="section-header">
                        <div class="tabs">
                            <div class="tab active" data-tab="vacations">
                                <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6.5 12c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4.5-2c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm6 0c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm4.5 2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM12 3C6.48 3 2 7.48 2 13s4.48 10 10 10 10-4.48 10-10S17.52 3 12 3zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                                </svg>
                                Vacaciones
                            </div>
                            <div class="tab" data-tab="projects">
                                <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                                </svg>
                                Proyectos
                            </div>
                            <div class="tab" data-tab="occupancy">
                                <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                                </svg>
                                Ocupaci√≥n
                            </div>
                            <div class="tab" data-tab="all">
                                <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
                                </svg>
                                Todo
                            </div>
                        </div>
                    </div>
                    <div class="section-content table-wrapper" style="max-height:450px;">
                        <table><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
                        <div class="no-data hidden" id="noData">No hay datos</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EDITOR TAB -->
    <div class="tab-content" id="editorTab">
        <div class="main-content" id="editorContent">
            <div class="download-section">
                <button id="downloadJsonBtn" class="btn-success">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;vertical-align:middle;">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    Descargar JSON
                </button>
                <button id="saveFileBtn" class="btn-warning">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;vertical-align:middle;">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Sincronizar Base de Datos
                </button>
                <span class="file-info" id="fileInfo">Base de Datos SQL Server</span>
                <span class="file-info" id="sasStatus" style="font-size:0.75rem;color:var(--text-secondary);"></span>
            </div>

            <div class="editor-grid">
                <div>
                    <div class="master-section">
                        <h3>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;">
                                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                            </svg>
                            Personas
                        </h3>
                        <input type="text" id="searchPersonInput" class="search-master-input" placeholder="üîç Buscar persona..." style="width:100%;margin-bottom:0.5rem;padding:0.5rem;">
                        <div class="master-list" id="personsList"></div>
                        <div class="add-master-row">
                            <input type="text" id="newPersonInput" placeholder="Nueva persona...">
                            <button id="addPersonBtn" class="btn-sm">+ A√±adir</button>
                        </div>
                    </div>
                    <div class="master-section" style="margin-top:1rem;">
                        <h3>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;">
                                <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                            </svg>
                            Proyectos (Phase)
                        </h3>
                        <input type="text" id="searchProjectInput" class="search-master-input" placeholder="üîç Buscar proyecto..." style="width:100%;margin-bottom:0.5rem;padding:0.5rem;">
                        <div class="master-list" id="projectsList"></div>
                        <div class="add-master-row">
                            <input type="text" id="newProjectInput" placeholder="Nuevo proyecto...">
                            <button id="addProjectBtn" class="btn-sm">+ A√±adir</button>
                        </div>
                    </div>
                    <div class="master-section" style="margin-top:1rem;">
                        <h3>
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                            </svg>
                            Tareas
                        </h3>
                        <input type="text" id="searchTaskInput" class="search-master-input" placeholder="üîç Buscar tarea..." style="width:100%;margin-bottom:0.5rem;padding:0.5rem;">
                        <div class="master-list" id="tasksList"></div>
                        <div class="add-master-row">
                            <input type="text" id="newTaskInput" placeholder="Nueva tarea...">
                            <button id="addTaskBtn" class="btn-sm">+ A√±adir</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="entry-form">
                        <h3 id="formTitle">
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Nueva Entrada
                        </h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Persona *</label>
                                <div class="searchable-select" id="entryPersonSelect">
                                    <input type="text" class="searchable-select-input" id="entryPersonInput" placeholder="Seleccionar persona..." readonly>
                                    <span class="searchable-select-arrow">‚ñº</span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="üîç Buscar persona..." id="entryPersonSearch">
                                        </div>
                                        <div class="searchable-select-options" id="entryPersonOptions"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Proyecto (Phase) *</label>
                                <div class="searchable-select" id="entryProjectSelect">
                                    <input type="text" class="searchable-select-input" id="entryProjectInput" placeholder="Seleccionar proyecto..." readonly>
                                    <span class="searchable-select-arrow">‚ñº</span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="üîç Buscar proyecto..." id="entryProjectSearch">
                                        </div>
                                        <div class="searchable-select-options" id="entryProjectOptions"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Tarea *</label>
                                <div class="searchable-select" id="entryTaskSelect">
                                    <input type="text" class="searchable-select-input" id="entryTaskInput" placeholder="Seleccionar tarea..." readonly>
                                    <span class="searchable-select-arrow">‚ñº</span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="üîç Buscar tarea..." id="entryTaskSearch">
                                        </div>
                                        <div class="searchable-select-options" id="entryTaskOptions"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Fecha Inicio *</label>
                                <input type="date" id="entryStart">
                            </div>
                            <div class="form-group">
                                <label>Fecha Fin *</label>
                                <input type="date" id="entryEnd">
                            </div>
                            <div class="form-group">
                                <label>Horas/d√≠a</label>
                                <input type="number" id="entryTime" value="8" min="1" max="24">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button id="saveEntryBtn">
                                <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;vertical-align:middle;">
                                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                                </svg>
                                Guardar Entrada
                            </button>
                            <button id="cancelEditBtn" class="btn-secondary hidden">Cancelar</button>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <h2>
                                <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;">
                                    <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
                                </svg>
                                Entradas de la Base de Datos
                            </h2>
                            <div style="display:flex;align-items:center;gap:1rem;">
                            <span style="color:var(--text-secondary);font-size:0.85rem;" id="entriesCount">0 entradas</span>
                                <button id="refreshEditorDataBtn" class="btn-success" style="padding:0.4rem 0.8rem;font-size:0.85rem;">
                                    <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;vertical-align:middle;">
                                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                    </svg>
                                    Refrescar
                                </button>
                            </div>
                        </div>
                        <div class="section-content entries-table-wrapper">
                            <table class="entries-table">
                                <thead id="entriesHead"></thead>
                                <tbody id="entriesBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="tooltip" id="tooltip"></div>

<script>
// Configuraci√≥n API Backend
// ‚ö†Ô∏è IMPORTANTE: Si tu HTML est√° en Azure Blob Storage, configura aqu√≠ la URL de tu API backend
// Detectar entorno
const isDevelopment = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1';

// URL de producci√≥n - Azure App Service
const API_BASE_URL = isDevelopment 
    ? 'http://localhost:3000'  // Desarrollo local
    : 'https://webcontrolhoras-api-g9eucxepedfehfe6.westeurope-01.azurewebsites.net'; // Producci√≥n

const API_URL = `${API_BASE_URL}/api/registros`;
const API_AUTH_URL = `${API_BASE_URL}/api/auth/verify`;
const API_PERSONAS_URL = `${API_BASE_URL}/api/personas`;
const API_PROYECTOS_URL = `${API_BASE_URL}/api/proyectos`;
const API_TAREAS_URL = `${API_BASE_URL}/api/tareas`;

console.log('API URL configurada:', API_URL);

// Variables de autenticaci√≥n
let currentUser = null;
let authToken = null;

// Funci√≥n para obtener headers con autenticaci√≥n
function getAuthHeaders() {
    return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
    };
}

// Verificar autenticaci√≥n al cargar
async function checkAuthentication() {
    authToken = localStorage.getItem('authToken');
    const userData = localStorage.getItem('userData');

    if (!authToken || !userData) {
        window.location.href = 'login.html';
        return false;
    }

    // Verificar que el token sea v√°lido
    try {
        const response = await fetch(API_AUTH_URL, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        if (!response.ok) {
            // Token inv√°lido, redirigir a login
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
            return false;
        }

        const data = await response.json();
        currentUser = data.user;
        
        // Actualizar UI seg√∫n rol
        updateUIForRole();
        
        return true;
    } catch (err) {
        console.error('Error al verificar autenticaci√≥n:', err);
        localStorage.removeItem('authToken');
        localStorage.removeItem('userData');
        window.location.href = 'login.html';
        return false;
    }
}

// Actualizar UI seg√∫n el rol del usuario
function updateUIForRole() {
    if (!currentUser) return;

    // Mostrar informaci√≥n del usuario
    document.getElementById('userInfo').textContent = `${currentUser.usuario} (${currentUser.rol})`;

    // Mostrar bot√≥n de gesti√≥n de usuarios solo para admin
    if (currentUser.rol === 'admin') {
        document.getElementById('btnGestionUsuarios').style.display = 'block';
    }

    // Ocultar botones de edici√≥n/eliminaci√≥n para visor
    if (currentUser.rol === 'visor') {
        // Ocultar botones de a√±adir/editar/eliminar
        const addButtons = document.querySelectorAll('[onclick*="showEntryForm"]');
        const editButtons = document.querySelectorAll('[onclick*="editEntry"]');
        const deleteButtons = document.querySelectorAll('[onclick*="deleteEntry"]');
        
        addButtons.forEach(btn => btn.style.display = 'none');
        editButtons.forEach(btn => btn.style.display = 'none');
        deleteButtons.forEach(btn => btn.style.display = 'none');
        
        // Ocultar pesta√±a de editor si existe
        const editorTab = document.querySelector('[data-maintab="editor"]');
        if (editorTab) editorTab.style.display = 'none';
    }
}

// Obtener el rol del usuario actual
function getUserRole() {
    if (!currentUser) {
        // Intentar obtener del localStorage si no est√° en memoria
        const userData = localStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                return user.rol || null;
            } catch (e) {
                return null;
            }
        }
        return null;
    }
    return currentUser.rol || null;
}

// Verificar si el usuario tiene un rol requerido
function hasRequiredRole(...requiredRoles) {
    const userRole = getUserRole();
    if (!userRole) return false;
    return requiredRoles.includes(userRole);
}

// Funci√≥n de logout
function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userData');
    window.location.href = 'login.html';
}

let jsonData = [];
let masterPersons = []; // Array de objetos {id, nombre}
let masterProjects = []; // Array de objetos {id, nombre}
let masterTasks = []; // Array de objetos {id, nombre}
let selectedPersons = new Set();
let editingId = null; // Cambiar de √≠ndice a ID de base de datos
let currentFileName = 'Base de Datos SQL Server';

// Filtros para tabla de entradas
let entryFilters = { person: '', project: '', task: '', start: '', end: '' };

function parseDate(str) {
    if (!str) return null;
    const [d, m, y] = str.split('/');
    return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
}

function formatDateToInput(str) {
    if (!str) return '';
    const [d, m, y] = str.split('/');
    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
}

function formatDateFromInput(str) {
    if (!str) return '';
    const [y, m, d] = str.split('-');
    return `${d}/${m}/${y}`;
}

function getWorkingDays(start, end) {
    const days = [];
    const d = new Date(start);
    while (d <= end) {
        const dow = d.getDay();
        if (dow !== 0 && dow !== 6) {
            days.push(new Date(d));
        }
        d.setDate(d.getDate() + 1);
    }
    return days;
}

function calculateDailyHoursWithTasks(person, startDate, endDate) {
    const dailyData = {};
    const workingDays = getWorkingDays(startDate, endDate);
    
    workingDays.forEach(day => {
        const dateKey = day.toISOString().slice(0, 10);
        dailyData[dateKey] = { hours: 0, tasks: [], date: day };
    });
    
    jsonData.filter(d => d.assignee === person).forEach(entry => {
        const entryStart = parseDate(entry.start);
        const entryEnd = parseDate(entry.end);
        if (!entryStart || !entryEnd) return;
        
        workingDays.forEach(day => {
            if (day >= entryStart && day <= entryEnd) {
                const dateKey = day.toISOString().slice(0, 10);
                const hours = entry.time || 8;
                dailyData[dateKey].hours += hours;
                dailyData[dateKey].tasks.push({ phase: entry.phase, task: entry.task, hours });
            }
        });
    });
    
    return dailyData;
}

// Cargar maestros desde la base de datos
async function loadMasters() {
    try {
        // Cargar personas
        const personasResponse = await fetch(API_PERSONAS_URL, {
            headers: getAuthHeaders()
        });
        if (personasResponse.ok) {
            const personas = await personasResponse.json();
            // Normalizar activo: si es undefined/null, asumir activo (1), si es boolean convertir a 0/1
            masterPersons = personas.map(p => ({ 
                id: p.id, 
                nombre: p.nombre, 
                activo: p.activo === undefined || p.activo === null ? 1 : (p.activo === true || p.activo === 1 ? 1 : 0)
            }));
            // Ordenar: activos primero, luego inactivos, ambos por nombre
            masterPersons.sort((a, b) => {
                if (a.activo !== b.activo) return b.activo - a.activo; // Activos primero
                return a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase());
            });
            
            // Debug: verificar que se cargan inactivos para admin
            const userRole = getUserRole();
            if (userRole === 'admin') {
                const inactivos = masterPersons.filter(p => p.activo === 0);
                if (inactivos.length > 0) {
                    console.log('Admin: Se cargaron', inactivos.length, 'personas inactivas:', inactivos.map(p => p.nombre));
                }
            }
        }
        
        // Cargar proyectos
        const proyectosResponse = await fetch(API_PROYECTOS_URL, {
            headers: getAuthHeaders()
        });
        if (proyectosResponse.ok) {
            const proyectos = await proyectosResponse.json();
            masterProjects = proyectos.map(p => ({ 
                id: p.id, 
                nombre: p.nombre, 
                activo: p.activo === undefined || p.activo === null ? 1 : (p.activo === true || p.activo === 1 ? 1 : 0)
            }));
            masterProjects.sort((a, b) => {
                if (a.activo !== b.activo) return b.activo - a.activo;
                return a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase());
            });
        }
        
        // Cargar tareas
        const tareasResponse = await fetch(API_TAREAS_URL, {
            headers: getAuthHeaders()
        });
        if (tareasResponse.ok) {
            const tareas = await tareasResponse.json();
            masterTasks = tareas.map(t => ({ 
                id: t.id, 
                nombre: t.nombre, 
                activo: t.activo === undefined || t.activo === null ? 1 : (t.activo === true || t.activo === 1 ? 1 : 0)
            }));
            masterTasks.sort((a, b) => {
                if (a.activo !== b.activo) return b.activo - a.activo;
                return a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase());
            });
        }
    } catch (err) {
        console.error('Error al cargar maestros:', err);
    }
}

function updateMastersFromData() {
    // Ya no actualizamos desde jsonData, se cargan desde la BD
    // Esta funci√≥n se mantiene por compatibilidad pero ya no hace nada
}

async function initializeApp(data) {
    jsonData = data || [];
    
    // Debug: verificar datos cargados
    console.log('initializeApp - jsonData length:', jsonData.length);
    if (jsonData.length > 0) {
        console.log('Primera entrada de ejemplo:', jsonData[0]);
    }
    
    // Cargar maestros desde la base de datos
    await loadMasters();
    
    // NO inicializar selectedPersons con todas las personas - empezar vac√≠o
    // selectedPersons se inicializar√° vac√≠o para que los KPIs muestren 0 al inicio
    if (selectedPersons.size === 0) {
        selectedPersons = new Set();
    }
    
    // Inicializar currentDate al mes actual si no est√° inicializado
    if (!currentDate || isNaN(currentDate.getTime())) {
        currentDate = new Date();
    }
    
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('mainContent').classList.add('visible');
    document.getElementById('editorContent').classList.add('visible');
    
    refreshAll();
}

async function loadFromAPI() {
    try {
        const response = await fetch(API_URL + '?t=' + Date.now(), {
            headers: getAuthHeaders()
        });
        
        if (response.status === 401 || response.status === 403) {
            logout();
            return;
        }
        
        if (!response.ok) throw new Error('Error al cargar: ' + response.status);
        const data = await response.json();
        await initializeApp(data);
    } catch (err) {
        document.getElementById('loadingScreen').innerHTML = `
            <div class="error-box">
                <div style="font-size:2rem;margin-bottom:1rem;">‚ùå</div>
                <div>Error al cargar datos desde la base de datos: ${err.message}</div>
                <div style="margin-top:0.5rem;font-size:0.9rem;color:var(--text-secondary);">Verifica que el servidor backend est√© corriendo y que la conexi√≥n a SQL Server est√© configurada.</div>
                <button onclick="loadFromAPI()" style="margin-top:1rem;">üîÑ Reintentar</button>
            </div>`;
    }
}

async function saveToAPI() {
    // Los cambios ya se guardan autom√°ticamente cuando se insertan/actualizan registros
    // Esta funci√≥n recarga los datos desde la base de datos para sincronizar
    const saveBtn = document.getElementById('saveFileBtn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = '‚è≥ Sincronizando...';
    saveBtn.disabled = true;
    
    try {
        await loadFromAPI();
        alert('‚úÖ Datos sincronizados correctamente desde la base de datos');
    } catch (err) {
        alert(`‚ùå Error al sincronizar: ${err.message}`);
    } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

function refreshAll() {
    renderMasterLists();
    populateSelects();
    renderPersonSelector();
    updateStats();
    renderTable();
    renderTimeline();
    renderEntriesTable();
    updateSASStatus();
}

function updateSASStatus() {
    const statusEl = document.getElementById('sasStatus');
    statusEl.textContent = '‚úì Conectado a Base de Datos SQL Server';
        statusEl.style.color = 'var(--success)';
}

// ========== MASTER LISTS ==========
function renderMasterLists() {
    const userRole = getUserRole();
    const isAdmin = userRole === 'admin';
    const canDelete = userRole === 'admin' || userRole === 'gestor';
    
    // Normalizar activo: SQL Server BIT puede venir como boolean o n√∫mero
    // Convertir a 0 o 1 para comparaciones consistentes
    const normalizeActivo = (activo) => {
        if (activo === undefined || activo === null) return 1; // Por defecto activo
        if (activo === true || activo === 1 || activo === '1') return 1;
        if (activo === false || activo === 0 || activo === '0') return 0;
        return 1; // Por defecto activo si no se reconoce
    };
    
    // Obtener filtros de b√∫squeda
    const searchPerson = (document.getElementById('searchPersonInput')?.value || '').toLowerCase().trim();
    const searchProject = (document.getElementById('searchProjectInput')?.value || '').toLowerCase().trim();
    const searchTask = (document.getElementById('searchTaskInput')?.value || '').toLowerCase().trim();
    
    // Filtrar y normalizar
    let visiblePersons = isAdmin 
        ? masterPersons.map(p => ({ ...p, activo: normalizeActivo(p.activo) }))
        : masterPersons.filter(p => normalizeActivo(p.activo) === 1).map(p => ({ ...p, activo: 1 }));
    let visibleProjects = isAdmin 
        ? masterProjects.map(p => ({ ...p, activo: normalizeActivo(p.activo) }))
        : masterProjects.filter(p => normalizeActivo(p.activo) === 1).map(p => ({ ...p, activo: 1 }));
    let visibleTasks = isAdmin 
        ? masterTasks.map(t => ({ ...t, activo: normalizeActivo(t.activo) }))
        : masterTasks.filter(t => normalizeActivo(t.activo) === 1).map(t => ({ ...t, activo: 1 }));
    
    // Aplicar filtro de b√∫squeda
    if (searchPerson) {
        visiblePersons = visiblePersons.filter(p => p.nombre.toLowerCase().includes(searchPerson));
    }
    if (searchProject) {
        visibleProjects = visibleProjects.filter(p => p.nombre.toLowerCase().includes(searchProject));
    }
    if (searchTask) {
        visibleTasks = visibleTasks.filter(t => t.nombre.toLowerCase().includes(searchTask));
    }
    
    // Trabajar con objetos {id, nombre, activo}
    document.getElementById('personsList').innerHTML = visiblePersons.length > 0 
        ? visiblePersons.map(p => {
            const activo = normalizeActivo(p.activo);
            const inactiveClass = activo === 0 ? ' style="opacity:0.5;text-decoration:line-through"' : '';
            const inactiveLabel = activo === 0 ? ' <span style="color:var(--danger);font-size:0.8rem;">(inactivo)</span>' : '';
            // Bot√≥n borrar: solo para activos y si tiene permisos
            const deleteBtn = (activo === 1 && canDelete) ? `<button class="btn-sm btn-danger" onclick="deleteMaster('person','${escapeHtml(p.nombre)}')">√ó</button>` : '';
            // Bot√≥n reactivar: solo para admin en inactivos
            const activateBtn = (activo === 0 && isAdmin) ? `<button class="btn-sm btn-success" onclick="activateMaster('person','${escapeHtml(p.nombre)}',${p.id})" title="Reactivar">‚Üª</button>` : '';
            return `<div class="master-item"${inactiveClass}><span>${p.nombre}${inactiveLabel}</span>${activateBtn}${deleteBtn}</div>`;
        }).join('')
        : '<div class="master-item" style="color:var(--text-secondary)">Sin personas</div>';
    
    document.getElementById('projectsList').innerHTML = visibleProjects.length > 0
        ? visibleProjects.map(p => {
            const activo = normalizeActivo(p.activo);
            const inactiveClass = activo === 0 ? ' style="opacity:0.5;text-decoration:line-through"' : '';
            const inactiveLabel = activo === 0 ? ' <span style="color:var(--danger);font-size:0.8rem;">(inactivo)</span>' : '';
            const deleteBtn = (activo === 1 && canDelete) ? `<button class="btn-sm btn-danger" onclick="deleteMaster('project','${escapeHtml(p.nombre)}')">√ó</button>` : '';
            const activateBtn = (activo === 0 && isAdmin) ? `<button class="btn-sm btn-success" onclick="activateMaster('project','${escapeHtml(p.nombre)}',${p.id})" title="Reactivar">‚Üª</button>` : '';
            return `<div class="master-item"${inactiveClass}><span>${p.nombre}${inactiveLabel}</span>${activateBtn}${deleteBtn}</div>`;
        }).join('')
        : '<div class="master-item" style="color:var(--text-secondary)">Sin proyectos</div>';
    
    document.getElementById('tasksList').innerHTML = visibleTasks.length > 0
        ? visibleTasks.map(t => {
            const activo = normalizeActivo(t.activo);
            const inactiveClass = activo === 0 ? ' style="opacity:0.5;text-decoration:line-through"' : '';
            const inactiveLabel = activo === 0 ? ' <span style="color:var(--danger);font-size:0.8rem;">(inactivo)</span>' : '';
            const deleteBtn = (activo === 1 && canDelete) ? `<button class="btn-sm btn-danger" onclick="deleteMaster('task','${escapeHtml(t.nombre)}')">√ó</button>` : '';
            const activateBtn = (activo === 0 && isAdmin) ? `<button class="btn-sm btn-success" onclick="activateMaster('task','${escapeHtml(t.nombre)}',${t.id})" title="Reactivar">‚Üª</button>` : '';
            return `<div class="master-item"${inactiveClass}><span>${t.nombre}${inactiveLabel}</span>${activateBtn}${deleteBtn}</div>`;
        }).join('')
        : '<div class="master-item" style="color:var(--text-secondary)">Sin tareas</div>';
}

function escapeHtml(str) {
    return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

async function addMaster(type) {
    const inputId = type === 'person' ? 'newPersonInput' : type === 'project' ? 'newProjectInput' : 'newTaskInput';
    const input = document.getElementById(inputId);
    const value = input.value.trim();
    if (!value) return;
    
    // Verificar permisos (solo admin y gestor pueden crear)
    const userRole = getUserRole();
    if (userRole !== 'admin' && userRole !== 'gestor') {
        alert('No tienes permisos para crear nuevos valores');
        return;
    }
    
    const button = type === 'person' ? document.getElementById('addPersonBtn') : 
                   type === 'project' ? document.getElementById('addProjectBtn') : 
                   document.getElementById('addTaskBtn');
    const originalText = button.textContent;
    button.textContent = '‚è≥ Guardando...';
    button.disabled = true;
    
    try {
        let apiUrl, body;
    
    if (type === 'person') {
            apiUrl = API_PERSONAS_URL;
            body = { nombre: value };
    } else if (type === 'project') {
            apiUrl = API_PROYECTOS_URL;
            body = { nombre: value };
    } else if (type === 'task') {
            apiUrl = API_TAREAS_URL;
            body = { nombre: value };
        }
        
        // Verificar primero si ya existe (llamada al backend)
        const checkResponse = await fetch(apiUrl, {
            method: 'GET',
            headers: getAuthHeaders()
        });
        
        if (checkResponse.status === 401 || checkResponse.status === 403) {
            logout();
            return;
        }
        
        if (checkResponse.ok) {
            const existing = await checkResponse.json();
            const exists = existing.some(item => item.nombre.toLowerCase() === value.toLowerCase());
            
            if (exists) {
                alert(`${type === 'person' ? 'Esta persona' : type === 'project' ? 'Este proyecto' : 'Esta tarea'} ya existe`);
                // Recargar la lista para obtener el ID
                await loadMasters();
                button.textContent = originalText;
                button.disabled = false;
                return;
            }
        }
        
        // Crear el nuevo valor
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(body)
        });
        
        if (response.status === 401 || response.status === 403) {
            logout();
            return;
        }
        
        if (response.status === 409) {
            // Ya existe (otro usuario lo cre√≥)
            const error = await response.json();
            alert(`${type === 'person' ? 'Esta persona' : type === 'project' ? 'Este proyecto' : 'Esta tarea'} ya existe`);
            // Recargar la lista para obtener el ID
            await loadMasters();
            button.textContent = originalText;
            button.disabled = false;
            return;
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al crear');
        }
        
        const newItem = await response.json();
        
        // Agregar a la lista local
        if (type === 'person') {
            masterPersons.push({ id: newItem.id, nombre: newItem.nombre });
            masterPersons.sort((a, b) => a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase()));
            selectedPersons.add(newItem.nombre);
        } else if (type === 'project') {
            masterProjects.push({ id: newItem.id, nombre: newItem.nombre });
            masterProjects.sort((a, b) => a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase()));
        } else if (type === 'task') {
            masterTasks.push({ id: newItem.id, nombre: newItem.nombre });
            masterTasks.sort((a, b) => a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase()));
    }
    
    input.value = '';
    refreshAll();
    } catch (err) {
        alert(`‚ùå Error al guardar: ${err.message}`);
        console.error('Error:', err);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

async function deleteMaster(type, value) {
    // Verificar permisos (solo admin y gestor pueden eliminar)
    const userRole = getUserRole();
    if (userRole !== 'admin' && userRole !== 'gestor') {
        alert('No tienes permisos para eliminar valores');
        return;
    }
    
    // Buscar el ID del elemento a eliminar
    let itemId = null;
    let apiUrl = null;
    let typeName = '';
    
    if (type === 'person') {
        const item = masterPersons.find(p => p.nombre === value);
        if (!item) {
            alert('No se encontr√≥ la persona');
            return;
        }
        itemId = item.id;
        apiUrl = `${API_PERSONAS_URL}/${itemId}`;
        typeName = 'persona';
    } else if (type === 'project') {
        const item = masterProjects.find(p => p.nombre === value);
        if (!item) {
            alert('No se encontr√≥ el proyecto');
            return;
        }
        itemId = item.id;
        apiUrl = `${API_PROYECTOS_URL}/${itemId}`;
        typeName = 'proyecto';
    } else if (type === 'task') {
        const item = masterTasks.find(t => t.nombre === value);
        if (!item) {
            alert('No se encontr√≥ la tarea');
            return;
        }
        itemId = item.id;
        apiUrl = `${API_TAREAS_URL}/${itemId}`;
        typeName = 'tarea';
    }
    
    if (!apiUrl || !itemId) {
        alert('Error: No se pudo encontrar el elemento');
        return;
    }
    
    // Primera confirmaci√≥n
    if (!confirm(`¬øEliminar "${value}"?`)) return;
    
    try {
        // Intentar eliminar sin cascade primero
        let response = await fetch(apiUrl, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (response.status === 401 || response.status === 403) {
            logout();
            return;
        }
        
        // Si hay registros asociados, el backend devuelve 409
        if (response.status === 409) {
            const errorData = await response.json();
            const count = errorData.count || 0;
            
            // Pedir confirmaci√≥n para eliminar tambi√©n los registros asociados
            const confirmMessage = `Esta ${typeName} tiene ${count} registro(s) asociado(s).\n\n` +
                `¬øDeseas eliminar tambi√©n todos los registros asociados?\n\n` +
                `Se marcar√°n como inactivos:\n` +
                `- La ${typeName} "${value}"\n` +
                `- Los ${count} registro(s) asociado(s)`;
            
            if (confirm(confirmMessage)) {
                // Reintentar con cascade=true
                response = await fetch(`${apiUrl}?cascade=true`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al eliminar con registros asociados');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message || `La ${typeName} y ${count} registro(s) fueron eliminados correctamente`}`);
            } else {
                // Usuario cancel√≥, no hacer nada
                return;
            }
        } else if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al eliminar');
        } else {
            // Eliminaci√≥n exitosa sin registros asociados
                const result = await response.json();
                if (result.message) {
                    alert(`‚úÖ ${result.message}`);
                }
        }
        
        // Si es admin, NO eliminar del array local, solo actualizar el estado a inactivo
        // Si NO es admin, eliminar del array local (no lo ver√° m√°s)
        const userRole = getUserRole();
        const isAdmin = userRole === 'admin';
        
        if (isAdmin) {
            // Admin: actualizar el estado a inactivo en el array local
    if (type === 'person') {
                const item = masterPersons.find(p => p.nombre === value);
                if (item) item.activo = 0;
            } else if (type === 'project') {
                const item = masterProjects.find(p => p.nombre === value);
                if (item) item.activo = 0;
            } else if (type === 'task') {
                const item = masterTasks.find(t => t.nombre === value);
                if (item) item.activo = 0;
            }
        } else {
            // No admin: eliminar del array local (no lo ver√° m√°s)
            if (type === 'person') {
                masterPersons = masterPersons.filter(p => p.nombre !== value);
        selectedPersons.delete(value);
    } else if (type === 'project') {
                masterProjects = masterProjects.filter(p => p.nombre !== value);
    } else if (type === 'task') {
                masterTasks = masterTasks.filter(t => t.nombre !== value);
            }
    }
    
        // Recargar maestros desde la BD para asegurar sincronizaci√≥n
        await loadMasters();
        // Recargar registros para reflejar los cambios
        await loadFromAPI();
    refreshAll();
    } catch (err) {
        alert(`‚ùå Error al eliminar: ${err.message}`);
        console.error('Error:', err);
    }
}

async function activateMaster(type, value, id) {
    // Verificar permisos (solo admin puede reactivar)
    const userRole = getUserRole();
    if (userRole !== 'admin') {
        alert('Solo los administradores pueden reactivar maestros');
        return;
    }
    
    if (!confirm(`¬øReactivar "${value}"?\n\nEsto tambi√©n reactivar√° los registros asociados si todos sus maestros est√°n activos.`)) return;
    
    let apiUrl = null;
    let typeName = '';
    
    if (type === 'person') {
        apiUrl = `${API_PERSONAS_URL}/${id}/activate`;
        typeName = 'persona';
    } else if (type === 'project') {
        apiUrl = `${API_PROYECTOS_URL}/${id}/activate`;
        typeName = 'proyecto';
    } else if (type === 'task') {
        apiUrl = `${API_TAREAS_URL}/${id}/activate`;
        typeName = 'tarea';
    }
    
    if (!apiUrl) {
        alert('Error: No se pudo determinar el endpoint');
        return;
    }
    
    try {
        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: getAuthHeaders()
        });
        
        if (response.status === 401 || response.status === 403) {
            logout();
            return;
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al reactivar');
        }
        
        const result = await response.json();
        const message = result.recordsReactivated > 0
            ? `‚úÖ ${typeName} reactivada. ${result.recordsReactivated} registro(s) tambi√©n reactivado(s).`
            : `‚úÖ ${typeName} reactivada.`;
        alert(message);
        
        // Recargar maestros desde la BD para obtener el estado actualizado
        await loadMasters();
        // Recargar registros desde la BD para mostrar los reactivados
        await loadFromAPI();
        // Refrescar toda la UI
        refreshAll();
    } catch (err) {
        alert(`‚ùå Error al reactivar: ${err.message}`);
        console.error('Error:', err);
    }
}

// ========== SEARCHABLE SELECT COMPONENT ==========
function initSearchableSelect(selectId, inputId, searchId, optionsId, data, placeholder, allowEmpty = true, emptyText = '') {
    const selectContainer = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    const searchInput = document.getElementById(searchId);
    const optionsContainer = document.getElementById(optionsId);
    
    if (!selectContainer || !input || !searchInput || !optionsContainer) return;
    
    // Limpiar event listeners anteriores si existen
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);
    const newSearchInput = searchInput.cloneNode(true);
    searchInput.parentNode.replaceChild(newSearchInput, searchInput);
    
    // Obtener referencias actualizadas
    const currentInput = document.getElementById(inputId);
    const currentSearchInput = document.getElementById(searchId);
    
    // Renderizar opciones
    function renderOptions(filterText = '') {
        const filter = filterText.toLowerCase().trim();
        const currentValue = currentInput.dataset.value || '';
        const filtered = data.filter(item => 
            !filter || item.nombre.toLowerCase().includes(filter)
        );
        
        optionsContainer.innerHTML = '';
        
        if (allowEmpty && !filter) {
            const emptyOption = document.createElement('div');
            emptyOption.className = 'searchable-select-option' + (currentValue === '' ? ' selected' : '');
            emptyOption.textContent = emptyText || placeholder;
            emptyOption.dataset.value = '';
            emptyOption.onclick = () => selectOption('');
            optionsContainer.appendChild(emptyOption);
        }
        
        filtered.forEach(item => {
            const option = document.createElement('div');
            option.className = 'searchable-select-option' + (currentValue === item.nombre ? ' selected' : '');
            option.textContent = item.nombre;
            option.dataset.value = item.nombre;
            option.dataset.id = item.id;
            option.onclick = () => selectOption(item.nombre, item.id);
            optionsContainer.appendChild(option);
        });
        
        if (filtered.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'searchable-select-no-results';
            noResults.textContent = 'No se encontraron resultados';
            optionsContainer.appendChild(noResults);
        }
    }
    
    function selectOption(value, id = null) {
        currentInput.value = value || '';
        currentInput.dataset.value = value || '';
        if (id) currentInput.dataset.id = id;
        selectContainer.classList.remove('open');
        currentSearchInput.value = '';
        renderOptions();
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        currentInput.dispatchEvent(event);
    }
    
    // Event listeners
    currentInput.addEventListener('click', (e) => {
        e.stopPropagation();
        selectContainer.classList.toggle('open');
        if (selectContainer.classList.contains('open')) {
            setTimeout(() => currentSearchInput.focus(), 10);
        }
    });
    
    currentSearchInput.addEventListener('input', (e) => {
        renderOptions(e.target.value);
    });
    
    currentSearchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            selectContainer.classList.remove('open');
            currentSearchInput.value = '';
            renderOptions();
        }
    });
    
    // Cerrar al hacer click fuera
    const clickOutsideHandler = (e) => {
        if (!selectContainer.contains(e.target)) {
            selectContainer.classList.remove('open');
        }
    };
    document.addEventListener('click', clickOutsideHandler);
    
    // Guardar handler para poder limpiarlo despu√©s si es necesario
    selectContainer._clickOutsideHandler = clickOutsideHandler;
    
    // Renderizar inicialmente
    renderOptions();
}

function populateSelects() {
    // Solo mostrar activos en los selects
    const activePersons = masterPersons.filter(p => {
        const activo = p.activo === undefined || p.activo === null ? 1 : (p.activo === true || p.activo === 1 ? 1 : 0);
        return activo === 1;
    });
    const activeProjects = masterProjects.filter(p => {
        const activo = p.activo === undefined || p.activo === null ? 1 : (p.activo === true || p.activo === 1 ? 1 : 0);
        return activo === 1;
    });
    const activeTasks = masterTasks.filter(t => {
        const activo = t.activo === undefined || t.activo === null ? 1 : (t.activo === true || t.activo === 1 ? 1 : 0);
        return activo === 1;
    });
    
    // Inicializar selects con b√∫squeda del formulario
    initSearchableSelect('entryPersonSelect', 'entryPersonInput', 'entryPersonSearch', 'entryPersonOptions', 
        activePersons, 'Seleccionar persona...', true, 'Seleccionar...');
    initSearchableSelect('entryProjectSelect', 'entryProjectInput', 'entryProjectSearch', 'entryProjectOptions', 
        activeProjects, 'Seleccionar proyecto...', true, 'Seleccionar...');
    initSearchableSelect('entryTaskSelect', 'entryTaskInput', 'entryTaskSearch', 'entryTaskOptions', 
        activeTasks, 'Seleccionar tarea...', true, 'Seleccionar...');
    
    // Inicializar selects con b√∫squeda de filtros
    initSearchableSelect('filterProjectSelect', 'filterProjectInput', 'filterProjectSearch', 'filterProjectOptions', 
        activeProjects, 'Todos', true, 'Todos');
    initSearchableSelect('filterTaskSelect', 'filterTaskInput', 'filterTaskSearch', 'filterTaskOptions', 
        activeTasks, 'Todas', true, 'Todas');
}

// ========== ENTRIES TABLE WITH FILTERS ==========
function getFilteredEntries() {
    return jsonData.filter(d => {
        if (entryFilters.person && !(d.assignee || '').toLowerCase().includes(entryFilters.person.toLowerCase())) return false;
        if (entryFilters.project && !(d.phase || '').toLowerCase().includes(entryFilters.project.toLowerCase())) return false;
        if (entryFilters.task && !(d.task || '').toLowerCase().includes(entryFilters.task.toLowerCase())) return false;
        if (entryFilters.start && !(d.start || '').includes(entryFilters.start)) return false;
        if (entryFilters.end && !(d.end || '').includes(entryFilters.end)) return false;
        return true;
    });
}

function renderEntriesTable() {
    const thead = document.getElementById('entriesHead');
    const tbody = document.getElementById('entriesBody');
    
    if (!thead || !tbody) {
        console.error('No se encontraron elementos entriesHead o entriesBody');
        return;
    }
    
    // Solo actualizar cabecera si no existe
    if (!thead.querySelector('input')) {
        thead.innerHTML = `
            <tr>
                <th>Persona<br><input type="text" id="filterEntryPerson" placeholder="Filtrar..."></th>
                <th>Proyecto<br><input type="text" id="filterEntryProject" placeholder="Filtrar..."></th>
                <th>Tarea<br><input type="text" id="filterEntryTask" placeholder="Filtrar..."></th>
                <th>Inicio<br><input type="text" id="filterEntryStart" placeholder="Filtrar..."></th>
                <th>Fin<br><input type="text" id="filterEntryEnd" placeholder="Filtrar..."></th>
                <th>Horas</th>
                <th>Acciones</th>
            </tr>`;
        
        // Add filter listeners una sola vez
        ['Person', 'Project', 'Task', 'Start', 'End'].forEach(field => {
            const input = document.getElementById(`filterEntry${field}`);
            if (input) {
                input.addEventListener('input', (e) => {
                    entryFilters[field.toLowerCase()] = e.target.value;
                    updateEntriesBody();
                });
            }
        });
    }
    
    updateEntriesBody();
}

function updateEntriesBody() {
    const tbody = document.getElementById('entriesBody');
    if (!tbody) {
        console.error('No se encontr√≥ el elemento entriesBody');
        return;
    }
    
    const filtered = getFilteredEntries();
    
    // Debug: verificar datos
    console.log('updateEntriesBody - jsonData length:', jsonData.length, 'filtered length:', filtered.length);
    
    tbody.innerHTML = filtered.length > 0 
        ? filtered.map((d) => {
            const realIndex = jsonData.indexOf(d);
            return `<tr>
                <td>${d.assignee || '-'}</td>
                <td>${d.phase || '-'}</td>
                <td>${d.task || '-'}</td>
                <td>${d.start || '-'}</td>
                <td>${d.end || '-'}</td>
                <td>${d.time || 8}</td>
                <td class="action-btns">
                    <button class="btn-sm btn-secondary" onclick="editEntry(${realIndex})" title="Editar">
                        <svg style="width:14px;height:14px;vertical-align:middle;" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </button>
                    <button class="btn-sm btn-danger" onclick="deleteEntry(${realIndex})" title="Eliminar">
                        <svg style="width:14px;height:14px;vertical-align:middle;" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </td>
            </tr>`;
        }).join('')
        : '<tr><td colspan="7" style="text-align:center;color:var(--text-secondary)">Sin entradas' + (jsonData.length === 0 ? ' - No hay datos cargados' : '') + '</td></tr>';
    
    const entriesCountEl = document.getElementById('entriesCount');
    if (entriesCountEl) {
        entriesCountEl.textContent = `${filtered.length}/${jsonData.length} entradas`;
    }
}

async function saveEntry() {
    const personInput = document.getElementById('entryPersonInput');
    const projectInput = document.getElementById('entryProjectInput');
    const taskInput = document.getElementById('entryTaskInput');
    const person = (personInput?.dataset.value || '').trim();
    const project = (projectInput?.dataset.value || '').trim();
    const task = (taskInput?.dataset.value || '').trim();
    const start = document.getElementById('entryStart').value;
    const end = document.getElementById('entryEnd').value;
    const time = parseInt(document.getElementById('entryTime').value) || 8;
    
    if (!person || !project || !task || !start || !end) {
        alert('Por favor, rellena todos los campos obligatorios (*)');
        return;
    }
    
    // Obtener IDs de los inputs
    const personId = personInput?.dataset.id;
    const projectId = projectInput?.dataset.id;
    const taskId = taskInput?.dataset.id;
    
    // Obtener referencias al bot√≥n antes de la validaci√≥n
    const saveBtn = document.getElementById('saveEntryBtn');
    const originalText = saveBtn.textContent;
    
    // Validar que la persona, proyecto y tarea est√©n activos en la BD antes de guardar
    // Esto es importante porque otro usuario puede haber dado de baja un elemento mientras este usuario est√° trabajando
    saveBtn.textContent = '‚è≥ Verificando...';
    saveBtn.disabled = true;
    
    try {
        const inactiveItems = [];
        
        // Verificar persona en la BD
        if (personId) {
            try {
                const personResponse = await fetch(`${API_PERSONAS_URL}/${personId}`, {
                    headers: getAuthHeaders()
                });
                if (personResponse.ok) {
                    const personData = await personResponse.json();
                    if (personData.activo === 0 || personData.activo === false) {
                        inactiveItems.push(`Persona: "${person}"`);
                    }
                }
            } catch (err) {
                console.error('Error al verificar persona:', err);
            }
        }
        
        // Verificar proyecto en la BD
        if (projectId) {
            try {
                const projectResponse = await fetch(`${API_PROYECTOS_URL}/${projectId}`, {
                    headers: getAuthHeaders()
                });
                if (projectResponse.ok) {
                    const projectData = await projectResponse.json();
                    if (projectData.activo === 0 || projectData.activo === false) {
                        inactiveItems.push(`Proyecto: "${project}"`);
                    }
                }
            } catch (err) {
                console.error('Error al verificar proyecto:', err);
            }
        }
        
        // Verificar tarea en la BD
        if (taskId) {
            try {
                const taskResponse = await fetch(`${API_TAREAS_URL}/${taskId}`, {
                    headers: getAuthHeaders()
                });
                if (taskResponse.ok) {
                    const taskData = await taskResponse.json();
                    if (taskData.activo === 0 || taskData.activo === false) {
                        inactiveItems.push(`Tarea: "${task}"`);
                    }
                }
            } catch (err) {
                console.error('Error al verificar tarea:', err);
            }
        }
        
        if (inactiveItems.length > 0) {
            // Recargar maestros para actualizar la lista
            await loadMasters();
            refreshAll();
            alert(`‚ö†Ô∏è No se puede crear la asignaci√≥n porque los siguientes elementos est√°n dados de baja:\n\n${inactiveItems.join('\n')}\n\nPor favor, selecciona elementos activos.`);
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            return;
        }
    } catch (err) {
        console.error('Error al verificar elementos activos:', err);
        // Continuar con el guardado si hay error en la verificaci√≥n
    }
    
    const entry = {
        phase: project, // Mantener nombre para compatibilidad
        phase_id: projectId ? parseInt(projectId) : null,
        task: task, // Mantener nombre para compatibilidad
        task_id: taskId ? parseInt(taskId) : null,
        milestone: null,
        start: formatDateFromInput(start),
        end: formatDateFromInput(end),
        completion: 0,
        dependencies: null,
        assignee: person, // Mantener nombre para compatibilidad
        assignee_id: personId ? parseInt(personId) : null,
        time: time
    };
    
    // Continuar con el guardado (saveBtn y originalText ya est√°n declarados arriba)
    saveBtn.textContent = '‚è≥ Guardando...';
    
    try {
        if (editingId) {
            // Actualizar registro existente
            const response = await fetch(`${API_URL}/${editingId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(entry)
            });
            
            if (response.status === 401 || response.status === 403) {
                logout();
                return;
            }
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Error al actualizar');
            }
            
            // Actualizar en el array local
            const index = jsonData.findIndex(d => d.id === editingId);
            if (index >= 0) {
                jsonData[index] = { ...entry, id: editingId };
            }
            
            editingId = null;
            document.getElementById('formTitle').innerHTML = '<svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Nueva Entrada';
        document.getElementById('cancelEditBtn').classList.add('hidden');
    } else {
            // Insertar nuevo registro
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(entry)
            });
            
            if (response.status === 401 || response.status === 403) {
                logout();
                return;
            }
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Error al insertar');
            }
            
            const result = await response.json();
            // Agregar al array local con el ID retornado
            jsonData.push({ ...entry, id: result.id });
    }
    
    clearEntryForm();
    updateMastersFromData();
    selectedPersons = new Set(masterPersons);
    refreshAll();
    } catch (err) {
        alert(`‚ùå Error al guardar: ${err.message}`);
        console.error('Error:', err);
    } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

function editEntry(index) {
    const entry = jsonData[index];
    editingId = entry.id; // Usar ID de base de datos en lugar de √≠ndice
    
    // Actualizar los nuevos inputs con b√∫squeda
    const personInput = document.getElementById('entryPersonInput');
    const projectInput = document.getElementById('entryProjectInput');
    const taskInput = document.getElementById('entryTaskInput');
    
    if (personInput) {
        personInput.value = entry.assignee || '';
        personInput.dataset.value = entry.assignee || '';
        // Buscar el ID de la persona
        const person = masterPersons.find(p => p.nombre === entry.assignee);
        if (person) personInput.dataset.id = person.id;
    }
    if (projectInput) {
        projectInput.value = entry.phase || '';
        projectInput.dataset.value = entry.phase || '';
        const project = masterProjects.find(p => p.nombre === entry.phase);
        if (project) projectInput.dataset.id = project.id;
    }
    if (taskInput) {
        taskInput.value = entry.task || '';
        taskInput.dataset.value = entry.task || '';
        const task = masterTasks.find(t => t.nombre === entry.task);
        if (task) taskInput.dataset.id = task.id;
    }
    
    document.getElementById('entryStart').value = formatDateToInput(entry.start);
    document.getElementById('entryEnd').value = formatDateToInput(entry.end);
    document.getElementById('entryTime').value = entry.time || 8;
    
    document.getElementById('formTitle').innerHTML = '<svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Editar Entrada';
    document.getElementById('cancelEditBtn').classList.remove('hidden');
    if (personInput) personInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Re-renderizar los selects para actualizar la selecci√≥n
    populateSelects();
}

async function deleteEntry(index) {
    if (!confirm('¬øEliminar esta entrada?')) return;
    
    const entry = jsonData[index];
    if (!entry.id) {
        alert('Error: No se puede eliminar - falta ID del registro');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/${entry.id}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (response.status === 401 || response.status === 403) {
            logout();
            return;
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al eliminar');
        }
        
        // Eliminar del array local
    jsonData.splice(index, 1);
    updateMastersFromData();
    refreshAll();
    } catch (err) {
        alert(`‚ùå Error al eliminar: ${err.message}`);
        console.error('Error:', err);
    }
}

function clearEntryForm() {
    // Limpiar los nuevos inputs con b√∫squeda
    const personInput = document.getElementById('entryPersonInput');
    const projectInput = document.getElementById('entryProjectInput');
    const taskInput = document.getElementById('entryTaskInput');
    
    if (personInput) {
        personInput.value = '';
        personInput.dataset.value = '';
        personInput.dataset.id = '';
    }
    if (projectInput) {
        projectInput.value = '';
        projectInput.dataset.value = '';
        projectInput.dataset.id = '';
    }
    if (taskInput) {
        taskInput.value = '';
        taskInput.dataset.value = '';
        taskInput.dataset.id = '';
    }
    
    document.getElementById('entryStart').value = '';
    document.getElementById('entryEnd').value = '';
    document.getElementById('entryTime').value = 8;
    editingId = null; // Resetear ID de edici√≥n
    document.getElementById('formTitle').innerHTML = '<svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;vertical-align:middle;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Nueva Entrada';
    document.getElementById('cancelEditBtn').classList.add('hidden');
    
    // Re-renderizar los selects para actualizar
    populateSelects();
}

function downloadJson() {
    const blob = new Blob([JSON.stringify(jsonData, null, '\t')], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentFileName || ('recursos_' + new Date().toISOString().slice(0,10) + '.json');
    a.click();
    URL.revokeObjectURL(url);
}


// ========== REPORTS ==========
function renderPersonSelector() {
    const container = document.getElementById('personSelector');
    const searchInput = document.getElementById('searchPersonSelector');
    const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';
    
    // Filtrar personas seg√∫n b√∫squeda
    let visiblePersons = masterPersons;
    if (searchText) {
        visiblePersons = masterPersons.filter(p => {
            const personName = p.nombre || p;
            return personName.toLowerCase().includes(searchText);
        });
    }
    
    // masterPersons ahora es array de objetos {id, nombre}
    container.innerHTML = visiblePersons.length > 0 
        ? visiblePersons.map(p => {
            const personName = p.nombre || p; // Compatibilidad: puede ser objeto o string
            const checked = selectedPersons.has(personName) ? 'checked' : '';
            const selectedClass = selectedPersons.has(personName) ? 'selected' : '';
            return `<div class="person-item ${selectedClass}" data-person="${escapeHtml(personName)}">
                <input type="checkbox" ${checked}>
                <span class="person-name">${personName}</span>
            </div>`;
        }).join('')
        : '<div style="padding:1rem;color:var(--text-secondary);text-align:center;">Sin personas' + (searchText ? ' que coincidan con la b√∫squeda' : '') + '</div>';
    
    container.querySelectorAll('.person-item').forEach(item => {
        item.addEventListener('click', (e) => {
            if (e.target.type !== 'checkbox') {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            }
            const person = item.dataset.person;
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox.checked) {
                selectedPersons.add(person);
                item.classList.add('selected');
            } else {
                selectedPersons.delete(person);
                item.classList.remove('selected');
            }
            updateStats(); renderTable(); renderTimeline();
        });
    });
}

function getFilterDateRange() {
    const fromStr = document.getElementById('filterDateFrom').value;
    const toStr = document.getElementById('filterDateTo').value;
    return {
        start: fromStr ? new Date(fromStr) : null,
        end: toStr ? new Date(toStr) : null
    };
}

function getFilteredData() {
    const projectInput = document.getElementById('filterProjectInput');
    const taskInput = document.getElementById('filterTaskInput');
    const project = projectInput?.dataset.value || '';
    const task = taskInput?.dataset.value || '';
    const type = document.getElementById('filterType').value;
    const dateRange = getFilterDateRange();

    return jsonData.filter(d => {
        if (!d.assignee) return false;
        if (selectedPersons.size > 0 && !selectedPersons.has(d.assignee)) return false;
        if (project && d.phase !== project) return false;
        if (task && d.task !== task) return false;
        if (type === 'vacation' && d.task !== 'Vacaciones') return false;
        if (type === 'project' && d.task === 'Vacaciones') return false;
        
        if (dateRange.start || dateRange.end) {
            const entryStart = parseDate(d.start);
            const entryEnd = parseDate(d.end);
            if (!entryStart || !entryEnd) return false;
            
            if (dateRange.start && dateRange.end) {
                if (entryEnd < dateRange.start || entryStart > dateRange.end) return false;
            } else if (dateRange.start) {
                if (entryEnd < dateRange.start) return false;
            } else if (dateRange.end) {
                if (entryStart > dateRange.end) return false;
            }
        }
        return true;
    });
}

function updateStats() {
    // Si no hay personas seleccionadas, todos los KPIs deben ser 0
    if (selectedPersons.size === 0) {
        document.getElementById('statPersons').textContent = 0;
        document.getElementById('statProjects').textContent = 0;
        document.getElementById('statVacations').textContent = 0;
        document.getElementById('statAssignments').textContent = 0;
        document.getElementById('statOverloaded').textContent = 0;
        return;
    }
    
    const filtered = getFilteredData();
    // El KPI de personas debe mostrar las personas seleccionadas
    const personsCount = selectedPersons.size;
    const uniqueProjects = [...new Set(filtered.filter(d => d.task !== 'Vacaciones').map(d => d.phase))];
    
    // Obtener el rango de fechas del filtro para contar vacaciones solo en ese rango
    let dateRange = getFilterDateRange();
    
    // Si no hay rango de fechas seleccionado, usar el rango del timeline actual
    if (!dateRange.start || !dateRange.end) {
        const { start, end } = getViewRange();
        dateRange = { start, end };
    }
    
    // Contar d√≠as de vacaciones solo dentro del rango de fechas seleccionado
    let vacDays = 0;
    if (dateRange.start && dateRange.end) {
        filtered.filter(d => d.task === 'Vacaciones').forEach(vac => {
            const vacStart = parseDate(vac.start);
            const vacEnd = parseDate(vac.end);
            if (vacStart && vacEnd) {
                // Calcular la intersecci√≥n entre el per√≠odo de vacaciones y el rango seleccionado
                const intersectionStart = vacStart > dateRange.start ? vacStart : dateRange.start;
                const intersectionEnd = vacEnd < dateRange.end ? vacEnd : dateRange.end;
                
                // Solo contar si hay intersecci√≥n v√°lida
                if (intersectionStart <= intersectionEnd) {
                    const workingDays = getWorkingDays(intersectionStart, intersectionEnd);
                    vacDays += workingDays.length;
                }
            }
        });
    } else {
        // Si no hay rango de fechas, contar todos los d√≠as de vacaciones de los datos filtrados
        filtered.filter(d => d.task === 'Vacaciones').forEach(vac => {
            const vacStart = parseDate(vac.start);
            const vacEnd = parseDate(vac.end);
            if (vacStart && vacEnd) {
                const workingDays = getWorkingDays(vacStart, vacEnd);
                vacDays += workingDays.length;
            }
        });
    }
    
    const projectCount = filtered.filter(d => d.task !== 'Vacaciones').length;
    
    // Calcular sobrecarga usando el mismo rango de fechas que se us√≥ para vacaciones
    let overloadedDays = 0;
    
    if (dateRange.start && dateRange.end) {
        [...selectedPersons].forEach(person => {
            const dailyData = calculateDailyHoursWithTasks(person, dateRange.start, dateRange.end);
            overloadedDays += Object.values(dailyData).filter(d => d.hours > 8).length;
        });
    }

    document.getElementById('statPersons').textContent = personsCount;
    document.getElementById('statProjects').textContent = uniqueProjects.length;
    document.getElementById('statVacations').textContent = vacDays;
    document.getElementById('statAssignments').textContent = projectCount;
    document.getElementById('statOverloaded').textContent = overloadedDays;
}

let currentTab = 'vacations';

function renderTable() {
    const filtered = getFilteredData();
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    const noData = document.getElementById('noData');
    const dateRange = getFilterDateRange();

    let tableData = [], headers = [];

    if (currentTab === 'vacations') {
        tableData = filtered.filter(d => d.task === 'Vacaciones');
        headers = ['Persona', 'Inicio', 'Fin', 'Horas/d√≠a'];
    } else if (currentTab === 'projects') {
        tableData = filtered.filter(d => d.task !== 'Vacaciones');
        headers = ['Persona', 'Proyecto', 'Tarea', 'Inicio', 'Fin', 'Horas/d√≠a'];
    } else if (currentTab === 'occupancy') {
        if (!dateRange.start || !dateRange.end) {
            thead.innerHTML = '';
            tbody.innerHTML = '';
            noData.innerHTML = '‚ö†Ô∏è Selecciona un rango de fechas (Desde y Hasta) para ver la ocupaci√≥n';
            noData.classList.remove('hidden');
            return;
        }
        
        noData.classList.add('hidden');
        thead.innerHTML = '';
        
        const workingDays = getWorkingDays(dateRange.start, dateRange.end);
        // Filtrar personas seleccionadas que existan en masterPersons (comparar nombres)
        const masterPersonNames = masterPersons.map(p => p.nombre || p);
        const personsToShow = [...selectedPersons].filter(p => masterPersonNames.includes(p)).sort();
        
        if (personsToShow.length === 0) {
            tbody.innerHTML = '<div class="no-data">Selecciona personas para ver la ocupaci√≥n</div>';
            return;
        }
        
        // Render como timeline
        let html = `<div class="timeline-header"><div class="timeline-header-name">Persona</div><div class="timeline-header-dates">`;
        
        let lastMonth = -1;
        workingDays.forEach((day, idx) => {
            const isMonthStart = day.getMonth() !== lastMonth;
            lastMonth = day.getMonth();
            const label = `${WEEKDAYS[day.getDay()]}<br>${day.getDate()}`;
            html += `<div class="timeline-date${isMonthStart && idx > 0 ? ' month-start' : ''}">${isMonthStart ? `<span class="timeline-month-label">${MONTHS_SHORT[day.getMonth()]}</span>` : label}</div>`;
        });
        html += `</div></div>`;
        
        personsToShow.forEach(person => {
            const dailyData = calculateDailyHoursWithTasks(person, dateRange.start, dateRange.end);
            const hasOverload = Object.values(dailyData).some(d => d.hours > 8);
            
            html += `<div class="timeline-row"><div class="timeline-row-name${hasOverload ? ' overloaded' : ''}">${person}${hasOverload ? ' ‚ö†Ô∏è' : ''}</div><div class="timeline-row-cells" style="display:flex;">`;
            
            let lastMonth2 = -1;
            workingDays.forEach((day, idx) => {
                const isMonthStart = day.getMonth() !== lastMonth2;
                lastMonth2 = day.getMonth();
                const dateKey = day.toISOString().slice(0, 10);
                const data = dailyData[dateKey] || { hours: 0, tasks: [] };
                
                let bgColor = 'var(--bg-secondary)';
                let textColor = 'var(--text-secondary)';
                if (data.hours > 8) { bgColor = 'var(--danger)'; textColor = '#fff'; }
                else if (data.hours === 8) { bgColor = 'var(--success)'; textColor = '#fff'; }
                else if (data.hours > 0) { bgColor = 'var(--warning)'; textColor = '#000'; }
                
                const tasksJson = JSON.stringify(data.tasks).replace(/"/g, '&quot;');
                const dateStr = day.toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
                
                html += `<div class="occupancy-cell${isMonthStart && idx > 0 ? ' month-start' : ''}" 
                    style="flex:1;min-width:32px;display:flex;align-items:center;justify-content:center;background:${bgColor};color:${textColor};font-size:0.7rem;font-weight:600;font-family:'JetBrains Mono',monospace;cursor:pointer;border-right:1px solid var(--border);"
                    data-date="${dateStr}" 
                    data-hours="${data.hours}" 
                    data-tasks="${tasksJson}"
                    data-person="${person}">${data.hours || ''}</div>`;
            });
            
            html += `</div></div>`;
        });
        
        tbody.innerHTML = `<tr><td colspan="6" style="padding:0;">${html}</td></tr>`;
        
        // Add tooltips
        document.querySelectorAll('.occupancy-cell').forEach(cell => {
            cell.addEventListener('mouseenter', (e) => {
                const date = cell.dataset.date;
                const hours = cell.dataset.hours;
                const person = cell.dataset.person;
                const tasks = JSON.parse(cell.dataset.tasks || '[]');
                
                let tooltipHtml = `<strong>${person}</strong><br>üìÖ ${date}<br>`;
                if (parseInt(hours) > 8) {
                    tooltipHtml += `<span style="color:var(--danger);font-weight:600;">‚ö†Ô∏è SOBRECARGA: ${hours}h</span>`;
                } else {
                    tooltipHtml += `Total: <strong>${hours}h</strong>`;
                }
                
                if (tasks.length > 0) {
                    tooltipHtml += '<hr style="margin:0.5rem 0;border-color:var(--border);">';
                    tooltipHtml += tasks.map(t => `<div class="tooltip-task">üìå <strong>${t.phase}</strong> - ${t.task}: ${t.hours}h</div>`).join('');
                } else {
                    tooltipHtml += '<br><span style="color:var(--text-secondary);">Sin tareas asignadas</span>';
                }
                
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = tooltipHtml;
                tooltip.classList.add('show');
            });
            cell.addEventListener('mousemove', (e) => {
                const tooltip = document.getElementById('tooltip');
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY - tooltip.offsetHeight - 10) + 'px';
            });
            cell.addEventListener('mouseleave', () => {
                document.getElementById('tooltip').classList.remove('show');
            });
        });
        
        return;
    } else {
        tableData = filtered;
        headers = ['Persona', 'Proyecto', 'Tarea', 'Inicio', 'Fin', 'Horas/d√≠a'];
    }

    thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

    if (tableData.length === 0) {
        tbody.innerHTML = '';
        noData.classList.remove('hidden');
        return;
    }
    noData.classList.add('hidden');

    if (currentTab === 'vacations') {
        tbody.innerHTML = tableData.map(d => `<tr><td>${d.assignee}</td><td>${d.start}</td><td>${d.end}</td><td>${d.time || 8}</td></tr>`).join('');
    } else if (currentTab === 'projects') {
        tbody.innerHTML = tableData.map(d => `<tr><td>${d.assignee}</td><td><span class="badge badge-project">${d.phase}</span></td><td>${d.task}</td><td>${d.start}</td><td>${d.end}</td><td>${d.time || '-'}</td></tr>`).join('');
    } else {
        tbody.innerHTML = tableData.map(d => `<tr><td>${d.assignee}</td><td><span class="badge ${d.task === 'Vacaciones' ? 'badge-vacation' : 'badge-project'}">${d.phase}</span></td><td>${d.task}</td><td>${d.start}</td><td>${d.end}</td><td>${d.time || '-'}</td></tr>`).join('');
    }
}

// ========== TIMELINE ==========
let currentDate = new Date();
let viewMode = 'month';

function getViewRange() {
    const start = new Date(currentDate);
    const end = new Date(currentDate);
    if (viewMode === 'week') {
        start.setDate(start.getDate() - start.getDay() + 1);
        end.setTime(start.getTime());
        end.setDate(end.getDate() + 4);
    } else if (viewMode === 'month') {
        start.setDate(1);
        end.setMonth(end.getMonth() + 1);
        end.setDate(0);
    } else if (viewMode === 'quarter') {
        const q = Math.floor(start.getMonth() / 3);
        start.setMonth(q * 3, 1);
        end.setMonth(q * 3 + 3, 0);
    } else {
        start.setMonth(0, 1);
        end.setMonth(11, 31);
    }
    return { start, end };
}

const MONTHS_FULL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const MONTHS_SHORT = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const WEEKDAYS = ['D','L','M','X','J','V','S'];

function formatPeriod() {
    const { start, end } = getViewRange();
    if (viewMode === 'week') return `${start.getDate()} ${MONTHS_SHORT[start.getMonth()]} - ${end.getDate()} ${MONTHS_SHORT[end.getMonth()]} ${end.getFullYear()}`;
    if (viewMode === 'month') return `${MONTHS_FULL[start.getMonth()]} ${start.getFullYear()}`;
    if (viewMode === 'quarter') return `Q${Math.floor(start.getMonth() / 3) + 1} ${start.getFullYear()} (${MONTHS_SHORT[start.getMonth()]} - ${MONTHS_SHORT[end.getMonth()]})`;
    return `A√±o ${start.getFullYear()}`;
}

function navigate(dir) {
    if (viewMode === 'week') currentDate.setDate(currentDate.getDate() + dir * 7);
    else if (viewMode === 'month') currentDate.setMonth(currentDate.getMonth() + dir);
    else if (viewMode === 'quarter') currentDate.setMonth(currentDate.getMonth() + dir * 3);
    else currentDate.setFullYear(currentDate.getFullYear() + dir);
    renderTimeline();
}

function renderTimeline() {
    const container = document.getElementById('timelineContainer');
    if (!container) {
        console.error('No se encontr√≥ el elemento timelineContainer');
        return;
    }
    
    // Si no hay personas seleccionadas, no mostrar nada en el timeline
    if (selectedPersons.size === 0) {
        container.innerHTML = '<div class="no-data">Selecciona personas para ver el timeline</div>';
        return;
    }
    
    const { start, end } = getViewRange();
    const days = getWorkingDays(start, end);
    const today = new Date(); today.setHours(0,0,0,0);

    const filterProjectInput = document.getElementById('filterProjectInput');
    const filterTaskInput = document.getElementById('filterTaskInput');
    const filterProject = filterProjectInput?.dataset.value || '';
    const filterTask = filterTaskInput?.dataset.value || '';
    const filterType = document.getElementById('filterType')?.value || '';

    // Usar nombres de personas seleccionadas
    let filteredPersons = [...selectedPersons].sort();
    let filteredData = jsonData.filter(d => {
        if (!d.assignee) return false;
        if (selectedPersons.size > 0 && !selectedPersons.has(d.assignee)) return false;
        if (filterProject && d.phase !== filterProject) return false;
        if (filterTask && d.task !== filterTask) return false;
        if (filterType === 'vacation' && d.task !== 'Vacaciones') return false;
        if (filterType === 'project' && d.task === 'Vacaciones') return false;
        const dStart = parseDate(d.start);
        const dEnd = parseDate(d.end);
        if (!dStart || !dEnd) return false;
        return dEnd >= start && dStart <= end;
    });

    document.getElementById('currentPeriod').textContent = formatPeriod();

    if (days.length === 0) {
        container.innerHTML = '<div class="no-data">Sin d√≠as laborables en este per√≠odo</div>';
        return;
    }

    let html = `<div class="timeline-header"><div class="timeline-header-name">Persona</div><div class="timeline-header-dates">`;
    
    let lastMonth = -1;
    days.forEach((day, idx) => {
        const isToday = day.getTime() === today.getTime();
        const isMonthStart = day.getMonth() !== lastMonth;
        lastMonth = day.getMonth();
        
        let label = '';
        if (viewMode === 'year') {
            if (isMonthStart) label = `<span class="timeline-month-label">${MONTHS_SHORT[day.getMonth()]}</span>`;
            else if (day.getDate() === 15) label = '15';
        } else if (viewMode === 'quarter') {
            if (isMonthStart) label = `<span class="timeline-month-label">${MONTHS_SHORT[day.getMonth()]}</span>`;
            else label = `${day.getDate()}`;
        } else {
            label = `${WEEKDAYS[day.getDay()]}<br>${day.getDate()}`;
        }
        
        html += `<div class="timeline-date${isToday ? ' today' : ''}${isMonthStart && idx > 0 ? ' month-start' : ''}">${label}</div>`;
    });
    html += `</div></div>`;

    if (filteredPersons.length === 0) {
        html += '<div class="no-data">Selecciona personas para ver el timeline</div>';
        container.innerHTML = html;
        return;
    }

    filteredPersons.forEach(person => {
        const personData = filteredData.filter(d => d.assignee === person);
        const dailyData = calculateDailyHoursWithTasks(person, start, end);
        const hasOverload = Object.values(dailyData).some(d => d.hours > 8);
        
        // Pre-calcular barras
        const personBars = [];
        personData.forEach(item => {
            const dStart = parseDate(item.start);
            const dEnd = parseDate(item.end);
            if (!dStart || !dEnd) return;
            
            let barStartIdx = -1, barEndIdx = -1;
            days.forEach((day, idx) => {
                if (day >= dStart && day <= dEnd) {
                    if (barStartIdx === -1) barStartIdx = idx;
                    barEndIdx = idx;
                }
            });
            
            if (barStartIdx !== -1 && barEndIdx !== -1) {
                personBars.push({ item, barStartIdx, barEndIdx });
            }
        });
        
        // Calcular niveles para evitar solapamientos
        personBars.forEach(bar => {
            let row = 0;
            while (personBars.some(other => 
                other !== bar && 
                other.row === row && 
                !(bar.barEndIdx < other.barStartIdx || bar.barStartIdx > other.barEndIdx)
            )) {
                row++;
            }
            bar.row = row;
        });
        
        const maxRows = Math.max(1, ...personBars.map(b => (b.row || 0) + 1));
        const rowHeight = Math.max(36, maxRows * 16 + 8);
        
        html += `<div class="timeline-row" style="min-height:${rowHeight}px;"><div class="timeline-row-name${hasOverload ? ' overloaded' : ''}">${person}${hasOverload ? ' ‚ö†Ô∏è' : ''}</div><div class="timeline-row-cells">`;
        
        let lastMonth2 = -1;
        days.forEach((day, idx) => {
            const isMonthStart = day.getMonth() !== lastMonth2;
            lastMonth2 = day.getMonth();
            html += `<div class="timeline-cell${isMonthStart && idx > 0 ? ' month-start' : ''}"></div>`;
        });
        
        personBars.forEach(bar => {
            const { item, barStartIdx, barEndIdx } = bar;
            const left = (barStartIdx / days.length) * 100;
            const width = ((barEndIdx - barStartIdx + 1) / days.length) * 100;
            const isVacation = item.task === 'Vacaciones';
            const label = isVacation ? 'Vac' : `${item.phase}`;
            const barHeight = Math.max(12, Math.min(14, 32 / maxRows));
            const topOffset = 4 + (bar.row * (barHeight + 2));
            html += `<div class="timeline-bar ${isVacation ? 'vacation' : 'project'}" style="left:${left}%;width:${width}%;top:${topOffset}px;height:${barHeight}px;" data-info="${item.phase}|${item.task}|${item.start}|${item.end}|${item.time || 8}h/d√≠a">${label}</div>`;
        });
        html += `</div></div>`;
    });

    container.innerHTML = html;

    container.querySelectorAll('.timeline-bar').forEach(bar => {
        bar.addEventListener('mouseenter', e => {
            const [phase, task, start, end, time] = bar.dataset.info.split('|');
            document.getElementById('tooltip').innerHTML = `<strong>${phase}</strong><br>${task}<br>üìÖ ${start} ‚Üí ${end}<br>‚è±Ô∏è ${time}`;
            document.getElementById('tooltip').classList.add('show');
        });
        bar.addEventListener('mousemove', e => {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        });
        bar.addEventListener('mouseleave', () => document.getElementById('tooltip').classList.remove('show'));
    });
}

// ========== LOAD DATA ON START ==========
document.addEventListener('DOMContentLoaded', async () => {
    // Inicializar currentDate al mes actual
    currentDate = new Date();
    viewMode = 'month';
    
    // Verificar autenticaci√≥n antes de cargar datos
    const isAuthenticated = await checkAuthentication();
    if (!isAuthenticated) {
        return; // Ya se redirigi√≥ a login
    }
    
    // Cargar datos desde la API
    updateSASStatus();
    loadFromAPI();
});

// ========== EVENTS ==========
document.querySelectorAll('.main-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.maintab + 'Tab').classList.add('active');
    });
});

document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        renderTable();
    });
});

document.querySelectorAll('.report-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.report-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.report + 'Panel').classList.add('active');
    });
});

document.querySelectorAll('#viewToggle button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#viewToggle button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        viewMode = btn.dataset.view;
        renderTimeline();
    });
});

document.getElementById('prevBtn').addEventListener('click', () => navigate(-1));
document.getElementById('nextBtn').addEventListener('click', () => navigate(1));
document.getElementById('todayBtn').addEventListener('click', () => { currentDate = new Date(); renderTimeline(); });

document.getElementById('selectAllBtn').addEventListener('click', () => {
    // Usar los nombres de las personas, no los objetos
    selectedPersons = new Set(masterPersons.map(p => p.nombre || p));
    renderPersonSelector(); updateStats(); renderTable(); renderTimeline();
});
document.getElementById('selectNoneBtn').addEventListener('click', () => {
    selectedPersons = new Set();
    renderPersonSelector(); updateStats(); renderTable(); renderTimeline();
});

// Event listeners para filtros
document.getElementById('filterType').addEventListener('change', () => { updateStats(); renderTable(); renderTimeline(); });
document.getElementById('filterDateFrom').addEventListener('change', () => { updateStats(); renderTable(); renderTimeline(); });
document.getElementById('filterDateTo').addEventListener('change', () => { updateStats(); renderTable(); renderTimeline(); });

// Event listeners para los nuevos selects con b√∫squeda de filtros
document.getElementById('filterProjectInput')?.addEventListener('change', () => { updateStats(); renderTable(); renderTimeline(); });
document.getElementById('filterTaskInput')?.addEventListener('change', () => { updateStats(); renderTable(); renderTimeline(); });

document.getElementById('clearFilters').addEventListener('click', () => {
    const filterProjectInput = document.getElementById('filterProjectInput');
    const filterTaskInput = document.getElementById('filterTaskInput');
    if (filterProjectInput) {
        filterProjectInput.value = '';
        filterProjectInput.dataset.value = '';
        filterProjectInput.dataset.id = '';
    }
    if (filterTaskInput) {
        filterTaskInput.value = '';
        filterTaskInput.dataset.value = '';
        filterTaskInput.dataset.id = '';
    }
    document.getElementById('filterType').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    updateStats(); renderTable(); renderTimeline();
});


document.getElementById('refreshDataBtn').addEventListener('click', loadFromAPI);
document.getElementById('refreshEditorDataBtn').addEventListener('click', async () => {
    await loadMasters();
    await loadFromAPI();
});

document.getElementById('addPersonBtn').addEventListener('click', () => addMaster('person'));
document.getElementById('addProjectBtn').addEventListener('click', () => addMaster('project'));
document.getElementById('addTaskBtn').addEventListener('click', () => addMaster('task'));

document.getElementById('newPersonInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addMaster('person'); });
document.getElementById('newProjectInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addMaster('project'); });
document.getElementById('newTaskInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addMaster('task'); });

// Event listeners para b√∫squeda en listas de maestros
document.getElementById('searchPersonInput').addEventListener('input', () => renderMasterLists());
document.getElementById('searchProjectInput').addEventListener('input', () => renderMasterLists());
document.getElementById('searchTaskInput').addEventListener('input', () => renderMasterLists());

// Event listener para b√∫squeda en selector de personas m√∫ltiple (informes)
document.getElementById('searchPersonSelector').addEventListener('input', () => renderPersonSelector());

document.getElementById('saveEntryBtn').addEventListener('click', saveEntry);
document.getElementById('cancelEditBtn').addEventListener('click', clearEntryForm);
document.getElementById('downloadJsonBtn').addEventListener('click', downloadJson);
document.getElementById('saveFileBtn').addEventListener('click', saveToAPI);
</script>
</body>
</html>

